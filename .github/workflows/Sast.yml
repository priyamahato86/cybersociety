name: SAST Scanning

on:
  workflow_dispatch: {}
  push:
    branches:
      - dev
  pull_request:
    branches:
      - main
      -  dev 

jobs:

    snyk:
      name: Snyk Scan
      runs-on: ubuntu-latest
  
      permissions:
        security-events: write
      # If your repository is private, also add:
        actions: read
        contents: read
  
      steps:
        - uses: actions/checkout@master
        - name: Run Snyk to check for vulnerabilities
          uses: snyk/actions/node@master
          continue-on-error: false # To make workflow fail when vuln detected
          env:
            SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          with:
            command: code test


    semgrep:
      name: Semgrep Scan
      runs-on: ubuntu-latest
      permissions:
        contents: read
        actions: read
      if: (github.actor != 'dependabot[bot]')
      steps:
        - uses: actions/checkout@v4
        - name: Install Semgrep
          run: pipx install semgrep
    
        - name: Run Semgrep (fail on findings)
          run: semgrep --config=auto --severity ERROR --severity WARNING .
                

    sonarqube:
          name: SonarQube
          runs-on: ubuntu-latest
          permissions:
            contents: read
            actions: read
          steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  show-progress: false
                  
            - name: SonarCloud Scan
              uses: sonarsource/sonarqube-scan-action@master
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
              with:
                args: >
                    -Dsonar.organization=cyber-society-msit
                    -Dsonar.projectKey=cybersociety-site
                    -Dsonar.log.level=WARN
                    
            - name: Check Sonar issues (FREE plan)
              run: |
                sudo apt-get install -y jq
                
                echo "Checking SonarCloud issues via API..."
            
                RESPONSE=$(curl -s \
                  -u "${{ secrets.SONAR_TOKEN }}:" \
                  "https://sonarcloud.io/api/issues/search?componentKeys=cybersociety-site&severities=CRITICAL,BLOCKER&resolved=false")
            
                COUNT=$(echo "$RESPONSE" | jq '.total')
            
                echo "Critical/Blocker issues found: $COUNT"
            
                if [ "$COUNT" -gt 0 ]; then
                  echo "âŒ SonarCloud vulnerabilities detected"
                  exit 1
                else
                  echo "âœ… No critical SonarCloud issues"
                fi     



    create_issue:
      name: Create / Update Security Issue
      needs: [snyk,semgrep,sonarqube]
      runs-on: ubuntu-latest
      if: always()
    
      permissions:
        contents: read
        issues: write
    
      steps:
        - name: Create / Update GitHub Issue
          uses: actions/github-script@v7
          with:
            github-token: ${{ secrets.GITHUB_TOKEN }}
            script: |
                const owner = context.repo.owner;
                const repo = context.repo.repo;
                const label = "security:sast";
                const title = "ðŸš¨ SAST Vulnerabilities Detected";
                
                const snykResult = "${{ needs.snyk.result }}";
                const semgrepResult = "${{ needs.semgrep.result }}";
                const sonarqubeResult = "${{ needs.sonarqube.result }}";
                const hasFailures =
                  snykResult === "failure" || semgrepResult === "failure" || sonarqubeResult === "failure";
                  
                
                const issues = await github.rest.issues.listForRepo({
                  owner,
                  repo,
                  state: "open",
                  labels: label,
                });
                
                const existingIssue = issues.data.find(i => i.title === title);
                
                if (!hasFailures && existingIssue) {
                  await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number: existingIssue.number,
                    state: "closed",
                  });
                
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: existingIssue.number,
                    body: "âœ… No SAST vulnerabilities detected. Closing issue automatically.",
                  });
                
                  return;
                }
                
                if (hasFailures) {
                  const body = `
                ### ðŸš¨ SAST Vulnerabilities Detected
                
                **Workflow:** ${context.workflow}
                **Branch:** ${context.ref}
                **Commit:** ${context.sha}
                
                ### Scan Results
                - **Snyk:** ${snykResult}
                - **Semgrep:** ${semgrepResult}
                - **SonarQube:** ${sonarqubeResult}
                
                ðŸ”— https://github.com/${owner}/${repo}/actions/runs/${context.runId}
                
                â›” This issue will auto-close when vulnerabilities are fixed.
                `;
                
                  if (existingIssue) {
                    await github.rest.issues.createComment({
                      owner,
                      repo,
                      issue_number: existingIssue.number,
                      body,
                    });
                  } else {
                    await github.rest.issues.create({
                      owner,
                      repo,
                      title,
                      body,
                      labels: [label],
                    });
                  }
                
                  core.setFailed("SAST vulnerabilities detected");
                }
