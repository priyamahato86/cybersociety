name: Secret Scanning

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [dev]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:

# =========================
# GITLEAKS SCAN
# =========================
  gitleaks-scan:
    runs-on: ubuntu-latest
    outputs:
      found: ${{ steps.result.outputs.found }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gitleaks
        run: |
          sudo apt update
          sudo apt install gitleaks -y

      - name: Run Gitleaks
        id: result
        run: |
          gitleaks detect --no-git -v --redact \
            && echo "found=false" >> $GITHUB_OUTPUT \
            || echo "found=true" >> $GITHUB_OUTPUT

      - name: Save Gitleaks Output
        if: always()
        run: |
          gitleaks detect  -v --redact > gitleaks-output.txt || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitleaks-output
          path: gitleaks-output.txt



  Issue-Creation:
    name: Create / Update Secret Scan Issue
    runs-on: ubuntu-latest
    needs: [gitleaks-scan]
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download scan artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create or Update GitHub Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const label = "security:secrets";
            const title = "ðŸš¨ Hard coded Secrets Detected";

            const gitleaksFound = "${{ needs.gitleaks-scan.outputs.found }}" === "true";
            const secretsFound = gitleaksFound ;

            const read = (p) =>
              fs.existsSync(p) ? fs.readFileSync(p, "utf8").trim() : "No issues found.";

            const gitleaksOutput = read("artifacts/gitleaks-output/gitleaks-output.txt");

            const body = `
            ### ðŸš¨ Hard coded Secrets Detected

            **Workflow:** ${context.workflow}
            **Branch:** ${context.ref}
            **Commit:** ${context.sha}

            ---

            ### ðŸ” Gitleaks
            \`\`\`
            ${gitleaksOutput}
            \`\`\`

            ---


            ðŸ”— **Run:** https://github.com/${owner}/${repo}/actions/runs/${context.runId}

            â›” This issue is auto-managed by GitHub Actions.
            `;

            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              labels: label,
            });

            const existingIssue = issues.data.find(
              (issue) => issue.title === title
            );

            // âœ… No secrets â†’ close existing issue
            if (!secretsFound) {
              if (existingIssue) {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: existingIssue.number,
                  state: "closed",
                });
              }
              return;
            }

            // ðŸš¨ Secrets found â†’ update or create issue
            if (existingIssue) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: existingIssue.number,
                body,
              });
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: [label],
              });
            }
