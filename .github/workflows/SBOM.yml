name: SBOM Scanning

on:
  workflow_dispatch: {}
  pull_request: {}
  push:
    branches:
      - dev

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin 

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Install Node dependencies
        run: |
          npm install

      - name: Generate SBOM for current repo (exclude .git, .github)
        run: |
           trivy fs . \
            --format cyclonedx \
            --include-dev-deps \
            --output output-sbom.json
      
      - name: Scan SBOM with Grype (human-readable)
        run: |
          grype sbom:output-sbom.json -o table > grype-table.txt

      - name: upload grype-table.txt
        uses: actions/upload-artifact@v4
        with:
          name: Reports
          path: grype-table.txt

      - name: Scan SBOM with Grype (fail on HIGH, save JSON)
        run: |
          trivy fs .   --format table  --scanners vuln  --severity HIGH,CRITICAL  --include-dev-deps
          grype sbom:output-sbom.json --fail-on high 






  create_sbom_issue:
    name: Create / Update SBOM Vulnerability Issue
    needs: security-scan
    runs-on: ubuntu-latest
    if: always()

    permissions:
      contents: read
      issues: write

    steps:
      - name: Download scan artifacts
        uses: actions/download-artifact@v4
        with:
          name: Reports

      - name: Create / Update GitHub Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const label = "security:sbom";
            const title = "ðŸš¨ Vulnerable Dependencies Detected (Grype)";
            const reportFile = "grype-table.txt";
            
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              labels: label
            });
            
            const existingIssue = issues.data.find(i => i.title === title);
            
            // Read file ONCE
            const tableOutput = fs.readFileSync(reportFile, "utf8");
            
            // ðŸŸ¢ No vulnerabilities â†’ close issue & exit
            if (
              tableOutput.includes("No vulnerabilities found") ||
              tableOutput.trim() === ""
            ) {
              if (existingIssue) {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: existingIssue.number,
                  state: "closed"
                });
              }
              return;
            }
            
            // ðŸ”´ Vulnerabilities exist â†’ create or update issue
            const body = `
            ### ðŸš¨ Vulnerable Dependencies Detected
            
            **Workflow:** ${context.workflow}
            **Branch:** ${context.ref}
            **Commit:** ${context.sha}
            
            ### ðŸ“¦ Grype Scan Output
            \`\`\`
            ${tableOutput}
            \`\`\`
            
            ðŸ”— **Run details**
            https://github.com/${owner}/${repo}/actions/runs/${context.runId}
            
            â›” This issue is automatically updated on every scan.
            `;
            
            if (existingIssue) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: existingIssue.number,
                body
              });
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: [label]
              });
            }
